generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

/////////////////////
// Enums
/////////////////////

enum Role {
  landlord
  tenant
  admin
}

enum DocumentType {
  rent_receipt
  verification
  statement
}

enum LeaseStatus {
  active
  ended
  pending
}

enum BillType {
  rent
  electricity
  water
  other
}

enum PaymentStatus {
  pending
  paid
  overdue
  cancelled
}

enum NotificationType {
  info
  warning
  error
  system
}

enum MaintenanceStatus {
  requested
  in_progress
  completed
  cancelled
}

enum ReminderStatus {
  pending
  sent
  failed
}

/////////////////////
// Core models
/////////////////////

model User {
  id        String   @id @default(uuid())
  name      String?
  email     String   @unique
  password  String? //made it optional for now 
  createdAt DateTime @default(now())

  landlord Landlord?
  tenant   Tenant?

  userRoles     UserRole[]
  notifications Notification[]
}

model UserRole {
  id         String   @id @default(uuid())
  userId     String
  role       Role
  landlordId String?
  createdAt  DateTime @default(now())

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  landlord Landlord? @relation(fields: [landlordId], references: [id])

  @@index([userId])
  @@index([landlordId])
}

model Landlord {
  id           String   @id @default(uuid())
  userId       String   @unique
  name         String
  contactPhone String?
  createdAt    DateTime @default(now())

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenants    Tenant[]
  properties Property[]
  tenancies  Tenancy[]
  bills      Bill[]
  documents  Document[]
  userRoles  UserRole[]

  maintenanceRequests MaintenanceRequest[]
  paymentReminders    PaymentReminder[]

  inviteTokens InviteToken[]

  @@index([userId])
}

model Tenant {
  id         String   @id @default(uuid())
  userId     String   @unique
  landlordId String
  fullName   String
  address    String?
  createdAt  DateTime @default(now())

  // Contact
  phone                String?
  email                String?

  // Emergency contact
  emergencyContact      String?
  emergencyContactPhone String?

  // ID verification
  idType               String?   // "Aadhaar" | "PAN" | "Passport"
  idNumber             String?

  // Police verification
  policeVerificationNumber String?
  policeVerificationDate   DateTime?

  // Personal details
  dateOfBirth          DateTime?
  occupation           String?
  workplace            String?
  moveInDate           DateTime?

  user                User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  landlord            Landlord             @relation(fields: [landlordId], references: [id])
  tenancies           Tenancy[]
  bills               Bill[]
  documents           Document[]
  maintenanceRequests MaintenanceRequest[]
  paymentReminders    PaymentReminder[]
  inviteTokens InviteToken[]

  @@index([userId])
  @@index([landlordId])
}

model Property {
  id           String   @id @default(uuid())
  landlordId   String
  address      String
  description  String?
  status       String   @default("VACANT")  // ← ADD THIS LINE
  createdAt    DateTime @default(now())
  
  landlord            Landlord             @relation(fields: [landlordId], references: [id])
  tenancies           Tenancy[]
  bills               Bill[]
  maintenanceRequests MaintenanceRequest[]
  activityLogs        ActivityLog[]        // ← ADD THIS LINE
  documents           Document[]  

  inviteTokens InviteToken[]
}

model Tenancy {
  id         String @id @default(uuid())
  landlordId String
  tenantId   String
  propertyId String

  leaseStart DateTime
  leaseEnd   DateTime?
  status     LeaseStatus
  
  monthlyRent     Decimal @db.Decimal(10, 2)  // ← ADD THIS LINE
  securityDeposit Decimal @db.Decimal(10, 2)
  currency        String  @default("USD")

  createdAt DateTime  @default(now())
  endedAt   DateTime?
  
  landlord Landlord @relation(fields: [landlordId], references: [id])
  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  bills     Bill[]
  documents Document[]

  @@index([landlordId])
  @@index([tenantId])
  @@index([propertyId])
}

model Bill {
  id         String @id @default(uuid())
  landlordId String
  tenancyId  String
  tenantId   String
  propertyId String

  // Billing Period
  month           DateTime
  dueDate         DateTime

  // Charges
  rent            Decimal  @db.Decimal(10, 2)
  
  electricityUnits Int?
  electricityRate  Decimal? @db.Decimal(10, 2)
  electricityTotal Decimal? @db.Decimal(10, 2)
  
  waterBill       Decimal? @db.Decimal(10, 2)
  carryForward    Decimal  @default(0) @db.Decimal(10, 2)
  
  // Totals
  totalBill       Decimal  @db.Decimal(10, 2)
  paidAmount      Decimal  @default(0) @db.Decimal(10, 2)
  remainingAmount Decimal  @db.Decimal(10, 2)
  
  // Status
  status   PaymentStatus
  
  // Notes
  note     String?  @db.Text
  
  currency String   @default("INR")
  
  // Edit tracking
  isEdited    Boolean   @default(false)
  editedAt    DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  paymentReminders PaymentReminder[]

  landlord Landlord @relation(fields: [landlordId], references: [id])
  tenancy  Tenancy  @relation(fields: [tenancyId], references: [id], onDelete: Cascade)
  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  documents Document[]
  payments  Payment[]

  ledgerEntries   LedgerEntry[]

  @@index([landlordId])
  @@index([tenancyId])
  @@index([tenantId])
  @@index([propertyId])
  @@index([month])
  @@unique([tenancyId, month])
}
model Payment {
  id              String   @id @default(uuid())
  
  // Bill Link
  billId          String
  bill            Bill     @relation(fields: [billId], references: [id], onDelete: Cascade)
  
  // Payment Details
  amount          Decimal  @db.Decimal(10, 2)
  
  // Dates
  paidAt          DateTime
  confirmedAt     DateTime?
  
  // Proof
  paymentProof    String?
  paymentMethod   String?
  
  // Verification (tenant confirms payment)
  verifiedByTenant    Boolean   @default(false)
  verifiedAt          DateTime?
  
  // Correction tracking
  isCorrection        Boolean   @default(false)
  correctionReason    String?
  originalPaymentId   String?
  
  // Notes
  note            String?   @db.Text
  
  // Timestamps
  createdAt       DateTime @default(now())
  
  @@index([billId])
  @@index([paidAt])
}

model LedgerEntry {
  id String @id @default(uuid())
  billId String
  
  entryDate DateTime
  // ❌ REMOVE: entryType String  (no longer needed)
  
  description String
  
  // ✅ NEW: Meter reading fields
  electricityPreviousReading Int?  // Auto-filled from last bill
  electricityCurrentReading Int?   // User enters
  electricityUnitsConsumed Int?    // Auto-calculated
  electricityRate Decimal? @db.Decimal(10,2)
  electricityTotal Decimal? @db.Decimal(10,2)  // Auto-calculated
  
  // ✅ CHANGE: Make optional
  waterBill Decimal? @db.Decimal(10,2)
  rentAmount Decimal? @db.Decimal(10,2)
  
  // Generic amounts
  debitAmount Decimal? @db.Decimal(10,2)
  creditAmount Decimal? @db.Decimal(10,2)
  
  // Payment details (all optional)
  paymentMethod String?
  paymentProof String?
  
  // Verification
  verifiedByTenant Boolean @default(false)
  verifiedAt DateTime?
  
  // Edit tracking
  isEdited Boolean @default(false)
  editedAt DateTime?
  
  // Metadata
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  bill Bill @relation(fields: [billId], references: [id], onDelete: Cascade)
  
  @@index([billId])
  @@index([entryDate])
}



model Document {
  id           String   @id @default(uuid())
  landlordId   String
  propertyId   String
  tenantId     String?
  billId       String?
  tenancyId    String?
  
  // Flexible fields (user-defined)
  documentName String       // Auto-capitalized
  category     String?      // Optional
  description  String?      // Optional
  
  // File metadata
  fileUrl      String
  fileSize     Int?
  mimeType     String?
  
  // Dates
  uploadedAt   DateTime     @default(now())
  documentDate DateTime?
  
  // Relations
  landlord Landlord  @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  tenant   Tenant?   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bill     Bill?     @relation(fields: [billId], references: [id], onDelete: Cascade)
  tenancy  Tenancy?  @relation(fields: [tenancyId], references: [id], onDelete: Cascade)
  property Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([landlordId])
  @@index([propertyId])
}

/////////////////////
// Operational models
/////////////////////

model PaymentReminder {
  id         String @id @default(uuid())
  landlordId String
  billId     String
  tenantId   String

  status         ReminderStatus
  reminderSentAt DateTime?
  createdAt      DateTime       @default(now())

  landlord Landlord @relation(fields: [landlordId], references: [id])
  bill     Bill     @relation(fields: [billId], references: [id])
  tenant   Tenant   @relation(fields: [tenantId], references: [id])

  @@index([landlordId])
  @@index([billId])
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  message   String
  read      Boolean          @default(false)
  sentAt    DateTime?
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model MaintenanceRequest {
  id         String @id @default(uuid())
  landlordId String
  tenantId   String?
  propertyId String

  // Issue details
  title       String
  description String
  category    String?
  priority    String            @default("MEDIUM")

  // Status tracking
  status      MaintenanceStatus @default(requested)
  resolutionNotes String?

  // Dates
  requestedAt DateTime          @default(now())
  completedAt DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  landlord Landlord @relation(fields: [landlordId], references: [id])
  tenant   Tenant?  @relation(fields: [tenantId], references: [id])
  property Property @relation(fields: [propertyId], references: [id])

  @@index([landlordId])
  @@index([propertyId])
  @@index([status])
}
model ActivityLog {
  id              String   @id @default(uuid())
  
  // Property Link
  propertyId      String
  property        Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  // Activity Details
  type            String
  description     String
  date            DateTime
  
  // Optional Links
  relatedId       String?
  
  // Timestamps
  createdAt       DateTime @default(now())
  
  @@index([propertyId])
  @@index([date])
  @@index([type])
}
model InviteToken {
  id         String    @id @default(uuid())
  token      String    @unique @default(uuid())
  email      String
  tenantId   String
  landlordId String
  propertyId String
  expiresAt  DateTime
  usedAt     DateTime?
  createdAt  DateTime  @default(now())

  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  landlord Landlord @relation(fields: [landlordId], references: [id])
  property Property @relation(fields: [propertyId], references: [id])

  @@index([token])
  @@index([email])
}
