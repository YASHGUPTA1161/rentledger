generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

/////////////////////
// Enums
/////////////////////

enum Role {
  landlord
  tenant
  admin
}

enum DocumentType {
  rent_receipt
  verification
  statement
}

enum LeaseStatus {
  active
  ended
  pending
}

enum BillType {
  rent
  electricity
  water
  other
}

enum PaymentStatus {
  pending
  paid
  overdue
  cancelled
}

enum NotificationType {
  info
  warning
  error
  system
}

enum MaintenanceStatus {
  requested
  in_progress
  completed
  cancelled
}

enum ReminderStatus {
  pending
  sent
  failed
}

/////////////////////
// Core models
/////////////////////

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())

  landlord Landlord?
  tenant   Tenant?

  userRoles     UserRole[]
  notifications Notification[]
}

model UserRole {
  id         String   @id @default(uuid())
  userId     String
  role       Role
  landlordId String?
  createdAt  DateTime @default(now())

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  landlord Landlord? @relation(fields: [landlordId], references: [id])

  @@index([userId])
  @@index([landlordId])
}

model Landlord {
  id           String   @id @default(uuid())
  userId       String   @unique
  name         String
  contactPhone String
  createdAt    DateTime @default(now())

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenants    Tenant[]
  properties Property[]
  tenancies  Tenancy[]
  bills      Bill[]
  documents  Document[]
  userRoles  UserRole[]

  maintenanceRequests MaintenanceRequest[]
  paymentReminders    PaymentReminder[]

  @@index([userId])
}

model Tenant {
  id         String   @id @default(uuid())
  userId     String   @unique
  landlordId String
  fullName   String
  address    String?
  createdAt  DateTime @default(now())

  policeVerificationNumber String?
  policeVerificationDate   DateTime?

  user                User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  landlord            Landlord             @relation(fields: [landlordId], references: [id])
  tenancies           Tenancy[]
  bills               Bill[]
  documents           Document[]
  maintenanceRequests MaintenanceRequest[]
  paymentReminders    PaymentReminder[]

  @@index([userId])
  @@index([landlordId])
}

model Property {
  id           String   @id @default(uuid())
  landlordId   String
  address      String
  propertyType String
  description  String?
  createdAt    DateTime @default(now())

  landlord            Landlord             @relation(fields: [landlordId], references: [id])
  tenancies           Tenancy[]
  bills               Bill[]
  maintenanceRequests MaintenanceRequest[]

  @@index([landlordId])
}

model Tenancy {
  id         String @id @default(uuid())
  landlordId String
  tenantId   String
  propertyId String

  leaseStart DateTime
  leaseEnd   DateTime
  status     LeaseStatus

  securityDeposit Decimal @db.Decimal(10, 2)
  currency        String  @default("USD")

  createdAt DateTime  @default(now())
  endedAt   DateTime?

  landlord Landlord @relation(fields: [landlordId], references: [id])
  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  property Property @relation(fields: [propertyId], references: [id])

  bills     Bill[]
  documents Document[]

  @@index([landlordId])
  @@index([tenantId])
  @@index([propertyId])
}

model Bill {
  id         String @id @default(uuid())
  landlordId String
  tenancyId  String
  tenantId   String
  propertyId String

  billType    BillType
  periodStart DateTime
  periodEnd   DateTime
  dueDate     DateTime

  amount   Decimal       @db.Decimal(10, 2)
  currency String        @default("USD")
  status   PaymentStatus

  paidAt    DateTime?
  createdAt DateTime  @default(now())

  paymentReminders PaymentReminder[]

  landlord Landlord @relation(fields: [landlordId], references: [id])
  tenancy  Tenancy  @relation(fields: [tenancyId], references: [id])
  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  property Property @relation(fields: [propertyId], references: [id])

  documents Document[]

  @@index([landlordId])
  @@index([tenancyId])
  @@index([tenantId])
  @@index([propertyId])
}

model Document {
  id           String       @id @default(uuid())
  landlordId   String
  tenantId     String
  billId       String?
  tenancyId    String?
  documentType DocumentType
  fileUrl      String
  generatedAt  DateTime
  createdAt    DateTime     @default(now())

  landlord Landlord @relation(fields: [landlordId], references: [id])
  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  bill     Bill?    @relation(fields: [billId], references: [id])
  tenancy  Tenancy? @relation(fields: [tenancyId], references: [id])

  @@index([landlordId])
  @@index([tenantId])
  @@index([billId])
}

/////////////////////
// Operational models
/////////////////////

model PaymentReminder {
  id         String @id @default(uuid())
  landlordId String
  billId     String
  tenantId   String

  status         ReminderStatus
  reminderSentAt DateTime?
  createdAt      DateTime       @default(now())

  landlord Landlord @relation(fields: [landlordId], references: [id])
  bill     Bill     @relation(fields: [billId], references: [id])
  tenant   Tenant   @relation(fields: [tenantId], references: [id])

  @@index([landlordId])
  @@index([billId])
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  message   String
  read      Boolean          @default(false)
  sentAt    DateTime?
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model MaintenanceRequest {
  id         String @id @default(uuid())
  landlordId String
  tenantId   String
  propertyId String

  description String
  status      MaintenanceStatus @default(requested)
  requestedAt DateTime          @default(now())
  updatedAt   DateTime?
  createdAt   DateTime          @default(now())

  landlord Landlord @relation(fields: [landlordId], references: [id])
  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  property Property @relation(fields: [propertyId], references: [id])

  @@index([landlordId])
  @@index([propertyId])
  @@index([status])
}
